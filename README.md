# Off-Momentum LossMap Simulation
This repository contains the basic tools and files to simulate off-momentum loss maps using SixTrack in two different scenarios:

  1) Off-momentum losses at the start of the ramp
  2) Off-momentum cleaning

In each scenario, there are two ways of performing the simulation:

  1) Using DYNK module for energy or RF frequency trim.
  2) Using a pencil beam directly sample at the momentum primary collimator.

## Files included in the repositories

  - clean_input: contains lattice related input
    - fort.2: actual lattice. Notice that accelerating cavities (elements acsca) are included and set with non-zero parameters. If cavities are not included in fort.2 the ramp or frequency trim would not work. If you need to include them you need to generate againg the file fort.2 from MADX including the "cavall" argument when executing the sixtrack conversion. The current example is for 2015 lattice at injection (StartRamp) and Flat Top (Cleaning).
    - fort.3: the tracking option files. It must include the collimation block and the DYNK module for triming the parameters.
    - CollDB: Collimator Database
    - CollPositon: Collimator position file
    - Survey: Survey file.
    - lag_function.py (only Cleaning/wDYNK): Python script for generating the frequency trim to be loaded by DYNK.
    - generate_distribution (only wPencil): Python script for generating the initial distribution to be tracked when using the pencil beam approach.
  - analysis: contains the basic analysis Python scripts for postprocessing and generating the lossmaps 
    - lossmap.py: generates the loss map.
    - LMevo.py: plots the evolution of losses in both TCPs (IR3 and IR7) as a function of the frequency shift.
  - sixtrack_batch.sh: submission script
  - htcondor.sub: submission script options

## Instructions for running simulations in different scenarios

### 1 Start of the ramp

### 1.1 Start of the ramp using DYNK

  - Originally, the simulation was split in two parts. In the first part SixTrack was called without including the collimation module to speed up the simulations. The las 10k turns were simulated in a second part this time using SixTrack with the collimation module included. The traces and files used for this kind of simulations can still be found in the repository and submission scripts. It has been demonstrated that similar simulation results are obtained using only 10k turns for the full simulation without loss in accuracy. This simulation method is the one described below.
  - The DYNK module loads an external file that contains the reference energy per turn. This file is generated externally taking into accoun the number of turns of the simulation. File fort.3 has to be modified accordingly to fit the same number of turns.
  
### 1.2 Start of the ramp using pencil beam

  - In order to perform the simulation correctly, the beam distribution must be sampled directly a the IR3 primary collimator. To do that one can cycle the optics to obtain a fort.2 with TCP.6 first element.
  - The beam distribution is externaly generated (script included) and the energy of the reference particle must be adjusted so the impact parameter on the TCP is about 1um.
  - Run the simulations normally as regular collimation simulations.
  - The analysis script is cycled in such a way that the lossmap starts at the usual location (IP1).

### 2 Off-momentum cleaning

### 2.1 Off-momentum cleaning using DYNK

  - The RF cavity parameters used in the simulation via DYNK are loaded from an external file generated by a python script. This can be easily implemented directly in DYNK but the python script is kept for debugging porpuses. The total frequency trim and the number of turns can be modified in the script. File fort.3 must be modified accordingly (i.e. number of turns).

### 2.2 Off-momentum cleaning using pencil beam

  - In order to perform the simulation correctly, the beam distribution must be sampled directly a the IR3 primary collimator. To do that one can cycle the optics to obtain a fort.2 with TCP.6 first element.
  - The beam distribution is externaly generated (script included) and the energy of the reference particle must be adjusted so the impact parameter on the TCP is about 1um.
  - Run the simulations normally as regular collimation simulations.
  - The analysis script is cycled in such a way that the lossmap starts at the usual location (IP1).
